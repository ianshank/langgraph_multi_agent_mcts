groups:
  - name: mcts_framework_alerts
    interval: 30s
    rules:
      # High Error Rate
      - alert: HighErrorRate
        expr: rate(mcts_requests_total{status="error"}[5m]) / rate(mcts_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: mcts-framework
        annotations:
          summary: "High error rate detected in MCTS Framework"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          runbook_url: "docs/runbooks/high-error-rate.md"

      # High Latency P95
      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, rate(mcts_request_duration_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: warning
          service: mcts-framework
        annotations:
          summary: "High P95 latency detected"
          description: "P95 latency is {{ $value | humanizeDuration }} (threshold: 30s)"

      # High Latency P99
      - alert: HighLatencyP99
        expr: histogram_quantile(0.99, rate(mcts_request_duration_seconds_bucket[5m])) > 60
        for: 5m
        labels:
          severity: critical
          service: mcts-framework
        annotations:
          summary: "Critical P99 latency detected"
          description: "P99 latency is {{ $value | humanizeDuration }} (threshold: 60s)"

      # Memory Usage High
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / (1024 * 1024 * 1024) > 7
        for: 10m
        labels:
          severity: warning
          service: mcts-framework
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | printf \"%.2f\" }}GB (limit: 8GB)"

      # CPU Usage High
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: mcts-framework
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | printf \"%.2f\" }}%"

      # MCTS Iterations Timeout
      - alert: MCTSIterationTimeout
        expr: rate(mcts_iteration_timeouts_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: mcts-framework
        annotations:
          summary: "MCTS iterations timing out"
          description: "{{ $value }} timeouts per second"

      # LLM Provider Errors
      - alert: LLMProviderErrors
        expr: rate(llm_request_errors_total[5m]) > 0.5
        for: 5m
        labels:
          severity: critical
          service: mcts-framework
        annotations:
          summary: "LLM provider errors detected"
          description: "{{ $value }} LLM errors per second"

      # Service Down
      - alert: ServiceDown
        expr: up{job="mcts-framework"} == 0
        for: 1m
        labels:
          severity: critical
          service: mcts-framework
        annotations:
          summary: "MCTS Framework service is down"
          description: "Service has been unreachable for more than 1 minute"

      # Rate Limiting Triggered
      - alert: RateLimitingActive
        expr: rate(mcts_rate_limit_exceeded_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: mcts-framework
        annotations:
          summary: "Rate limiting is being triggered frequently"
          description: "{{ $value }} rate limit events per second"

      # Queue Depth High
      - alert: HighQueueDepth
        expr: mcts_request_queue_depth > 100
        for: 5m
        labels:
          severity: warning
          service: mcts-framework
        annotations:
          summary: "Request queue depth is high"
          description: "Current queue depth: {{ $value }}"

  - name: infrastructure_alerts
    rules:
      # Disk Space Low
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space"
          description: "Only {{ $value | printf \"%.2f\" }}% disk space remaining"

      # Container Restart
      - alert: ContainerRestarting
        expr: increase(container_restart_count[1h]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container restarting frequently"
          description: "Container has restarted {{ $value }} times in the last hour"
